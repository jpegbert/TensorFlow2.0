import tensorflow as tf


"""
TensorFlowé«˜çº§æ“ä½œ
"""


def gather():
    """
    ç°æ ¹æ®ç´¢å¼•å·æ”¶é›†æ•°æ®
    """
    # å‡è®¾å…±æœ‰ 4 ä¸ªç­çº§ï¼Œæ¯ä¸ªç­çº§ 35 ä¸ªå­¦ç”Ÿï¼Œ8 é—¨ç§‘ç›®ï¼Œä¿å­˜æˆç»©å†Œçš„å¼ é‡ shape ä¸º[4,35,8]
    x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32) # æˆç»©å†Œå¼ é‡
    # ç°åœ¨éœ€è¦æ”¶é›†ç¬¬1~2ä¸ªç­çº§çš„æˆç»©å†Œï¼Œå¯ä»¥ç»™å®šéœ€è¦æ”¶é›†ç­çº§çš„ç´¢å¼•å·ï¼š[0, 1]ï¼Œå¹¶æŒ‡å®šç­çº§çš„ç»´åº¦axis = 0ï¼Œ
    # é€šè¿‡tf.gatherå‡½æ•°æ”¶é›†æ•°æ®ï¼Œä»£ç å¦‚ä¸‹:
    res = tf.gather(x, [0, 1], axis=0)  # åœ¨ç­çº§ç»´åº¦æ”¶é›†ç¬¬ 1~2 å·ç­çº§æˆç»©å†Œ

    # æ”¶é›†ç¬¬ 1,4,9,12,13,27 å·åŒå­¦æˆç»©
    res = tf.gather(x, [0, 3, 8, 11, 12, 26], axis=1)

    # å¦‚æœéœ€è¦æ”¶é›†æ‰€æœ‰åŒå­¦çš„ç¬¬ 3 å’Œç¬¬ 5 é—¨ç§‘ç›®çš„æˆç»©ï¼Œåˆ™å¯ä»¥æŒ‡å®šç§‘ç›®ç»´åº¦ axis=2
    res = tf.gather(x, [2, 4], axis=2) # ç¬¬3, 5ç§‘ç›®çš„æˆç»©

    # tf.gather éå¸¸é€‚åˆç´¢å¼•å·æ²¡æœ‰è§„åˆ™çš„åœºåˆï¼Œå…¶ä¸­ç´¢å¼•å·å¯ä»¥ä¹±åºæ’åˆ—ï¼Œæ­¤æ—¶æ”¶é›†çš„æ•°æ®ä¹Ÿæ˜¯å¯¹åº”é¡ºåº
    a = tf.range(8)
    a = tf.reshape(a, [4, 2]) # ç”Ÿæˆå¼ é‡a
    tf.gather(a, [3, 1, 0, 2], axis=0)  # æ”¶é›†ç¬¬ 4,2,1,3 å·å…ƒç´ 

    # å¦‚æœå¸Œæœ›æŠ½æŸ¥ç¬¬[2,3]ç­çº§çš„ç¬¬[3,4,6,27]å·åŒå­¦çš„ç§‘ç›® æˆç»©ï¼Œåˆ™å¯ä»¥é€šè¿‡ç»„åˆå¤šä¸ª tf.gatherå®ç°ã€‚
    # é¦–å…ˆæŠ½å‡ºç¬¬[2,3]ç­çº§ï¼Œå®ç°å¦‚ä¸‹ï¼š
    students = tf.gather(x, [1, 2], axis=0)  # æ”¶é›†ç¬¬ 2,3 å·ç­çº§
    # å†ä»è¿™ 2 ä¸ªç­çº§çš„åŒå­¦ä¸­æå–å¯¹åº”å­¦ç”Ÿæˆç»©ï¼Œä»£ç å¦‚ä¸‹ï¼š
    # åŸºäº students å¼ é‡ç»§ç»­æ”¶é›†
    res = tf.gather(students, [2, 3, 5, 26], axis=1)  # æ”¶é›†ç¬¬ 3, 4ï¼Œ6ï¼Œ27å·5åŒå­¦

    # æŠ½æŸ¥ç¬¬äºŒä¸ªç­çº§çš„ç¬¬äºŒä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œç¬¬ä¸‰ä¸ªç­çº§çš„ç¬¬ä¸‰ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œç¬¬å››ä¸ªç­çº§çš„ç¬¬å››ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®
    res = tf.stack([x[1, 1], x[2, 2], x[3, 3]], axis=0)


def gather_nd():
    """
    æŒ‡å®šæ¯æ¬¡é‡‡æ ·ç‚¹çš„å¤šç»´åæ ‡æ¥å®ç°é‡‡æ ·å¤šä¸ªç‚¹
    """
    # å‡è®¾å…±æœ‰ 4 ä¸ªç­çº§ï¼Œæ¯ä¸ªç­çº§ 35 ä¸ªå­¦ç”Ÿï¼Œ8 é—¨ç§‘ç›®ï¼Œä¿å­˜æˆç»©å†Œçš„å¼ é‡ shape ä¸º[4,35,8]
    x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)  # æˆç»©å†Œå¼ é‡
    # æŠ½æŸ¥ç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œç¬¬ 3 ä¸ªç­çº§çš„ ç¬¬ 3 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # ç¬¬ 4 ä¸ªç­çº§çš„ç¬¬ 4 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ã€‚é‚£ä¹ˆè¿™ 3 ä¸ªé‡‡æ ·ç‚¹çš„ç´¢å¼• åæ ‡å¯ä»¥è®°ä¸ºï¼š
    # [1,1]ã€[2,2]ã€[3,3]ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé‡‡æ ·æ–¹æ¡ˆåˆå¹¶ä¸ºä¸€ä¸ª List å‚æ•°ï¼Œå³ [[1,1],[2,2],[3,3]]ï¼Œ
    # é€šè¿‡ tf.gather_nd å‡½æ•°å³å¯ï¼Œå®ç°å¦‚ä¸‹ï¼š
    res = tf.gather_nd(x, [[1, 1], [2, 2], [3, 3]])
    print(res)

    # æ ¹æ®å¤šç»´åº¦åæ ‡æ”¶é›†æ•°æ®
    res = tf.gather_nd(x, [[1, 1, 2], [2, 2, 3], [3, 3, 4]])
    print(res)


def boolean_mask():
    """
    é€šè¿‡æ©ç ï¼ˆMaskï¼‰çš„æ–¹å¼è¿›è¡Œé‡‡æ ·
    """
    # å‡è®¾å…±æœ‰ 4 ä¸ªç­çº§ï¼Œæ¯ä¸ªç­çº§ 35 ä¸ªå­¦ç”Ÿï¼Œ8 é—¨ç§‘ç›®ï¼Œä¿å­˜æˆç»©å†Œçš„å¼ é‡ shape ä¸º[4,35,8]
    x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)  # æˆç»©å†Œå¼ é‡
    # æ ¹æ®æ©ç æ–¹å¼é‡‡æ ·ç­çº§ï¼Œç»™å‡ºæ©ç å’Œç»´åº¦ç´¢å¼•
    res = tf.boolean_mask(x, mask=[True, False, False, True], axis=0)
    print(res)

    # é‡‡æ ·ç¬¬1 4 5 8é—¨ç§‘ç›®
    res = tf.boolean_mask(x, mask=[True, False, False, True, True, False, False, True], axis=2)
    print(res)

    # å¤šç»´æ©ç é‡‡æ ·
    # tf.boolean_mask(x, [[True, True, False], [False, True, True]])


def where():
    a = tf.ones([3, 3]) # æ„é€ å…¨1çŸ©é˜µ
    b = tf.zeros([3, 3]) # æ„é€ å…¨0çŸ©é˜µ

    # æ„å»ºé‡‡æ ·æ¡ä»¶
    cond = tf.constant([[True, False, False], [False, True, False], [True, True, False]])
    res = tf.where(cond, a, b) # æ ¹æ®æ¡ä»¶ä»aï¼Œbä¸­é‡‡æ ·, è¿”å›çš„å¼ é‡ä¸­ä¸º 1 çš„ä½ç½®å…¨éƒ¨æ¥è‡ªå¼ é‡ aï¼Œè¿”å›çš„å¼ é‡ä¸­ä¸º 0 çš„ä½ç½®æ¥è‡ªå¼ é‡ b

    res = tf.where(cond)  # è·å– cond ä¸­ä¸º True çš„å…ƒç´ ç´¢å¼•

    x = tf.random.normal([3, 3])  # æ„é€  a
    mask = x > 0  # æ¯”è¾ƒæ“ä½œï¼Œç­‰åŒäº tf.math.greater()
    # é€šè¿‡tf.whereæå–æ­¤æ©ç å¤„Trueå…ƒç´ çš„ç´¢å¼•åæ ‡ï¼š
    indices = tf.where(mask)  # æå–æ‰€æœ‰å¤§äº 0 çš„å…ƒç´ ç´¢å¼•
    # æ‹¿åˆ°ç´¢å¼•åï¼Œé€šè¿‡tf.gather_ndå³å¯æ¢å¤å‡ºæ‰€æœ‰æ­£æ•°çš„å…ƒç´ 
    res = tf.gather_nd(x, indices)  # æå–æ­£æ•°çš„å…ƒç´ å€¼
    # å½“æˆ‘ä»¬å¾—åˆ°æ©ç maskä¹‹åï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡tf.boolean_maskè·å–æ‰€æœ‰æ­£æ•°çš„å…ƒç´ å‘é‡:
    res = tf.boolean_mask(x, mask)  # é€šè¿‡æ©ç æå–æ­£æ•°çš„å…ƒç´ å€¼


def scatter_nd():
    # æ„é€ éœ€è¦åˆ·æ–°æ•°æ®çš„ä½ç½®å‚æ•°ï¼Œå³4 3 1 å’Œ7å·ä½ç½®
    indices = tf.constant([[4], [3], [1], [7]])
    # æ„é€ éœ€è¦å†™å…¥çš„æ•°æ®ï¼Œ4å·ä½ç½®å†™4.4,3å·ä½ç½®å†™3.3ï¼Œä»¥æ­¤ç±»æ¨
    updates = tf.constant([4.4, 3.3, 1.1, 7.7])
    # åœ¨é•¿åº¦ä¸º8çš„å…¨0å‘é‡ä¸Šæ ¹æ®indiceså†™å…¥updatesæ•°æ®
    res = tf.scatter_nd(indices, updates, [8])

    # æ„é€ ä¸¤ä¸ªå†™å…¥ä½ç½®
    indices = tf.constant([[1], [3]])
    updates = tf.constant([ # æ„é€ å†™å…¥æ•°æ®ï¼Œå³2ä¸ªçŸ©é˜µ
        [[5, 5, 5, 5], [6, 0, 6, 6], [7, 7, 7, 7], [8, 8, 8, 8]],
        [[1, 1, 1, 1], [2, 2, 2, 2], [3, 3, 3, 3], [4, 4, 4, 4]]
    ])
    # åœ¨shapeä¸º[4, 4, 4]çš„ç™½æ¿ä¸Šæ ¹æ®indiceså†™å…¥updates
    res = tf.scatter_nd(indices, updates, [4, 4, 4])


def sinc(x, y):
    z = tf.sqrt(x ** 2 + y ** 2)
    z = tf.sin(z) / z  # sinc å‡½æ•°å®ç°
    return z


def meshgrid():
    points = [] # ä¿å­˜æ‰€æœ‰ç‚¹çš„åæ ‡åˆ—è¡¨
    for x in range(-8, 8, 100): # å¾ªç¯ç”Ÿæˆxåæ ‡ï¼Œ100ä¸ªé‡‡æ ·ç‚¹
        for y in range(-8, 8, 100): # å¾ªç¯ç”Ÿæˆyåæ ‡ï¼Œ100ä¸ªé‡‡æ ·ç‚¹
            # è®¡ç®—æ¯ä¸ªç‚¹(x,y)å¤„çš„ sinc å‡½æ•°å€¼
            z = tf.sqrt(x ** 2 + y ** 2)
            z = tf.sin(z) / z  # sinc å‡½æ•°å®ç°
            points.append([x, y, z])  # ä¿å­˜é‡‡æ ·ç‚¹
    # ä¸Šé¢è¿™ç§æ–¹å¼æ•ˆç‡ä½ï¼Œé‡‡ç”¨tf.meshgrid
    x = tf.linspace(-8., 8, 100)  # è®¾ç½® x è½´çš„é‡‡æ ·ç‚¹
    y = tf.linspace(-8., 8, 100)  # è®¾ç½® y è½´çš„é‡‡æ ·ç‚¹
    x, y = tf.meshgrid(x, y)  # ç”Ÿæˆç½‘æ ¼ç‚¹ï¼Œå¹¶å†…éƒ¨æ‹†åˆ†åè¿”å›
    print(x.shape, y.shape) # æ‰“å°æ‹†åˆ†åçš„æ‰€æœ‰ç‚¹çš„ x,y åæ ‡å¼ é‡ shape
    z = tf.sqrt(x ** 2 + y ** 2)
    z = tf.sin(z) / z  # sinc å‡½æ•°å®ç°
    import matplotlib
    from matplotlib import pyplot as plt
    # å¯¼å…¥ 3D åæ ‡è½´æ”¯æŒ
    from mpl_toolkits.mplot3d import Axes3D

    fig = plt.figure()
    ax = Axes3D(fig)  # è®¾ç½® 3D åæ ‡è½´
    # æ ¹æ®ç½‘æ ¼ç‚¹ç»˜åˆ¶ sinc å‡½æ•° 3D æ›²é¢
    ax.contour3D(x.numpy(), y.numpy(), z.numpy(), 50)
    plt.show()


def main():
    # gather() # ç°æ ¹æ®ç´¢å¼•å·æ”¶é›†æ•°æ®
    # gather_nd() # æŒ‡å®šæ¯æ¬¡é‡‡æ ·ç‚¹çš„å¤šç»´åæ ‡æ¥å®ç°é‡‡æ ·å¤šä¸ªç‚¹
    # boolean_mask() # é€šè¿‡æ©ç ï¼ˆMaskï¼‰çš„æ–¹å¼è¿›è¡Œé‡‡æ ·
    # where() # é€šè¿‡ tf.where(cond, a, b)æ“ä½œå¯ä»¥æ ¹æ® cond æ¡ä»¶çš„çœŸå‡ä»å‚æ•°ğ‘¨æˆ–ğ‘©ä¸­è¯»å–æ•°æ®
    # scatter_nd() #
    meshgrid()


if __name__ == '__main__':
    main()
